<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Todo App</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
    }

    input,
    button {
      margin: 0.5em 0;
    }

    .task {
      margin: 0.5em 0;
      border: 1px solid #ccc;
      padding: 0.5em;
    }
  </style>

</head>

<body>
  <h1>Todo App</h1>

  <form id="taskForm">
    <input type="text" id="titulo" placeholder="Título" maxlength="100" required />
    <br />
    <textarea id="descripcion" placeholder="Descripción (opcional)" maxlength="500"></textarea>
    <br />
    <button type="submit">Agregar tarea</button>
  </form>

  <h2>Lista de tareas</h2>
  <div id="taskList"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const taskList = document.getElementById('taskList');
    const form = document.getElementById('taskForm');
    const tituloInput = document.getElementById('titulo');
    const descripcionInput = document.getElementById('descripcion');

    // Manejar envío del formulario
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const titulo = tituloInput.value.trim();
      const descripcion = descripcionInput.value.trim();

      if (!titulo) return;

      await fetch('/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ titulo, descripcion })
      });

      form.reset();
    });

    // Mostrar tareas en pantalla
    function mostrarTareas(tareas) {
      taskList.innerHTML = '';

      tareas.forEach(t => {
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `
          <strong>${t.titulo}</strong><br/>
          <em>${t.descripcion || ''}</em><br/>
          <small>Estado: ${t.status}</small><br/>
          <button onclick="eliminarTarea(${t.id})">Eliminar</button>
          <button onclick="editTask(${t.id})">Editar</button>
          <button onclick="cambiarEstado(${t.id},'${t.status}')">${t.status === 'pendiente' ? 'Completar' : 'Reabrir'}</button>
        `;
        taskList.appendChild(div);
      });
    }

    // Eliminar tarea
    async function eliminarTarea(id) {
      await fetch(`/tasks/${id}`, { method: 'DELETE' });
    }

    async function editTask(id) {
      const titulo = prompt('Nuevo título:');
      const descripcion = prompt('Nueva descripción:');

      if ((titulo !== null && titulo.trim() !== '') || (descripcion !== null && descripcion.trim() !== '')) {
        await fetch(`/tasks/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ titulo, descripcion })
        });
        loadTasks();
      }
    }
    // Cambiar estado de la tarea
    async function cambiarEstado(id, estado) {

      await fetch(`/tasks/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: `${(estado == 'pendiente') ? 'completada' : 'pendiente'}` }) // Cambia el estado a completada;
      });
    }

    // Escuchar tareas desde el servidor
    socket.on('tasksUpdated', mostrarTareas);

    // Cargar tareas por primera vez
    fetch('/tasks')
      .then(res => res.json())
      .then(mostrarTareas);


  </script>
</body>

</html>